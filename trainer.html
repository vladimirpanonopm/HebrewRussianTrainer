<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="utf-8" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä</title>
  <link href="style.css" rel="stylesheet" />
</head>
<body class="trainer">
  <h1>üß† –¢—Ä–µ–Ω–∞–∂—ë—Ä —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≤ –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–µ</h1>
  <div id="word" dir="rtl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div id="options"></div>
  <div id="feedback"></div>

  <div id="controls">
    <button class="control-button" id="autoToggle">‚ñ∂Ô∏è –ê–≤—Ç–æ</button>
    <button class="control-button" id="repeat">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    <button class="control-button" id="skip">üóë –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ</button>
    <button class="control-button" id="toggleFont">‚úèÔ∏è –†—É–∫–æ–ø–∏—Å–Ω—ã–π —à—Ä–∏—Ñ—Ç</button>
  </div>

  <div id="progress">–í—ã—É—á–µ–Ω–æ: 0 / 0 | –û—à–∏–±–æ–∫: 0</div>

  <div id="home-link">
    <a class="control-button" href="index.html">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>

  <script>
    let terms = [];
    let current = null;
    let audioMap = {};
    let learned = 0;
    let mistakes = 0;
    let audio = new Audio();
    let autoMode = false;
    let useHandwritten = false;

    function playAudio(hebrew) {
      const filename = audioMap[hebrew];
      if (filename) {
        audio.src = "audio/" + encodeURIComponent(filename);
        audio.play().catch(e => {
          console.warn("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", e);
        });
      }
    }

    function updateProgress() {
      document.getElementById("progress").innerText = `–í—ã—É—á–µ–Ω–æ: ${learned} / ${learned + terms.length} | –û—à–∏–±–æ–∫: ${mistakes}`;
    }

    function showWord() {
      if (terms.length === 0) {
        document.getElementById("word").innerText = "üéâ –í—Å–µ —Å–ª–æ–≤–∞ –∏–∑—É—á–µ–Ω—ã!";
        document.getElementById("options").innerHTML = "";
        return;
      }

      current = terms[Math.floor(Math.random() * terms.length)];
      const [hebrew, translation] = current;

      const wordDiv = document.getElementById("word");
      wordDiv.innerText = hebrew;
      wordDiv.className = useHandwritten ? "handwritten" : "";

      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      const shuffled = [...terms]
        .sort(() => Math.random() - 0.5)
        .slice(0, 4);
      if (!shuffled.includes(current)) {
        shuffled[Math.floor(Math.random() * 4)] = current;
      }

      shuffled.forEach(option => {
        const btn = document.createElement("button");
        btn.className = "option rus";
        btn.innerText = option[1];
        btn.onclick = () => {
          if (option === current) {
            terms = terms.filter(t => t !== current);
            learned++;
            feedback("‚úî –í–µ—Ä–Ω–æ!", "success");
            setTimeout(showWord, 500);
          } else {
            mistakes++;
            feedback("‚ùå –ù–µ–≤–µ—Ä–Ω–æ...", "warning");
          }
          updateProgress();
        };
        optionsDiv.appendChild(btn);
      });

      playAudio(hebrew);
    }

    function feedback(text, cls) {
      const el = document.getElementById("feedback");
      el.innerText = text;
      el.className = cls;
    }

    function skipWord() {
      terms = terms.filter(t => t !== current);
      learned++;
      updateProgress();
      showWord();
    }

    function repeatWord() {
      if (current) playAudio(current[0]);
    }

    function startAuto() {
      autoMode = true;
      document.getElementById("autoToggle").innerText = "‚èπ –°—Ç–æ–ø";
      loopAuto();
    }

    function stopAuto() {
      autoMode = false;
      document.getElementById("autoToggle").innerText = "‚ñ∂Ô∏è –ê–≤—Ç–æ";
    }

    function loopAuto() {
      if (!autoMode || terms.length === 0) return;
      showWord();
      let delay = audio.duration ? (audio.duration * 1000 + 1800) : 3000;
      setTimeout(loopAuto, delay);
    }

    document.getElementById("repeat").onclick = repeatWord;
    document.getElementById("skip").onclick = skipWord;
    document.getElementById("autoToggle").onclick = () => {
      autoMode ? stopAuto() : startAuto();
    };
    document.getElementById("toggleFont").onclick = () => {
      useHandwritten = !useHandwritten;
      showWord();
    };

    Promise.all([
      fetch("terms.json").then(r => r.json()),
      fetch("audio_map.json").then(r => r.json())
    ]).then(([data, map]) => {
      terms = data;
      audioMap = map;
      updateProgress();
      showWord();
    });
  </script>
</body>
</html>
