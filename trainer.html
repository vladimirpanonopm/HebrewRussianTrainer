<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –∏–≤—Ä–∏—Ç–æ-—Ä—É—Å—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ —Å –æ–∑—É—á–∫–æ–π</title>
  <link rel="stylesheet" href="style.css" />
  <style>
  @font-face {
    font-family: "GveretLevin";
    src: url("GveretLevinAlefAlefAlef-Regular.ttf") format("truetype");
  }

  .handwritten {
    font-family: "GveretLevin", cursive !important;
  }
</style>

</head>
<body class="trainer">
  <h1>üß† –¢—Ä–µ–Ω–∞–∂—ë—Ä —Å–∞–º–æ–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –≤ –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–µ</h1>
  <div id="word">&#1494;&#1493;&#1502;&#1508;&#1512;...</div>
  <div id="options"></div>
  <div id="feedback"></div>
  <div id="controls">
    <button id="repeat" class="control-button">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    <button id="skip" class="control-button">üóë –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å —ç—Ç–æ —Å–ª–æ–≤–æ</button>
    <button id="restart" class="control-button" style="display:none">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    <button id="retryErrors" class="control-button" style="display:none">üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–∫–∏</button>
    <button id="toggleFont" class="control-button">‚úèÔ∏è –†—É–∫–æ–ø–∏—Å–Ω—ã–π —à—Ä–∏—Ñ—Ç</button>
  </div>
  <div id="progress">–í—ã—É—á–µ–Ω–æ: 0 –∏–∑ 0 | –û—à–∏–±–æ–∫: 0</div>
  <div id="home-link">
    <a href="index.html" class="control-button">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>
<script>
  let allTerms = [];
  let terms = [];
  let fullTerms = [];
  let audioMap = {};
  let current = null;
  let wrongAnswers = [];
  let isHandwritten = false;

  const level = new URLSearchParams(window.location.search).get("level") || "beg";

  function playAudio(hebrew) {
    const filename = audioMap[hebrew];
    if (filename) {
      new Audio("audio/" + encodeURIComponent(filename)).play();
    }
  }

  function updateProgress() {
    document.getElementById("progress").innerText =
      `–í—ã—É—á–µ–Ω–æ: ${allTerms.length - terms.length} –∏–∑ ${allTerms.length} | –û—à–∏–±–æ–∫: ${wrongAnswers.length}`;
  }

  function showWord() {
  updateProgress();

  if (terms.length === 0) {
    document.getElementById("word").innerText = "üéâ –í—Å–µ —Å–ª–æ–≤–∞ –∏–∑—É—á–µ–Ω—ã!";
    document.getElementById("options").innerHTML = "";
    document.getElementById("feedback").innerText = "";
    document.getElementById("repeat").style.display = "none";
    document.getElementById("skip").style.display = "none";
    document.getElementById("restart").style.display = "inline-block";
    if (wrongAnswers.length > 0) {
      document.getElementById("retryErrors").style.display = "inline-block";
    }
    return;
  }

  current = terms[Math.floor(Math.random() * terms.length)];
  const wordEl = document.getElementById("word");
  wordEl.innerText = current[0];
  wordEl.setAttribute("dir", "rtl");
  wordEl.classList.toggle("handwritten", isHandwritten);
  playAudio(current[0]);

  const optDiv = document.getElementById("options");
  optDiv.innerHTML = "";
  document.getElementById("feedback").innerText = "";

  let options = [current];
  while (options.length < Math.min(5, terms.length)) {
    let rand = terms[Math.floor(Math.random() * terms.length)];
    if (!options.includes(rand)) options.push(rand);
  }
  options.sort(() => Math.random() - 0.5);

  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "option rus";
    btn.innerText = opt[1];
    btn.setAttribute("dir", "ltr");

    btn.onclick = () => {
      btn.blur(); // —Å–Ω–∏–º–∞–µ–º —Ñ–æ–∫—É—Å

      if (opt === current) {
        document.getElementById("feedback").innerText = "‚úî –í–µ—Ä–Ω–æ";
        updateProgress();
        setTimeout(showWord, 1000);
      } else {
        document.getElementById("feedback").innerText = "‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ù–∞–∂–º–∏—Ç–µ –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç";
        playAudio(current[0]);
        wrongAnswers.push(current);
        updateProgress();

        document.querySelectorAll(".option").forEach(b => {
          b.disabled = true;
          if (b.innerText === current[1]) {
            b.disabled = false;
            b.classList.add("correct");
            b.onclick = () => {
              b.blur();
              setTimeout(showWord, 500);
            };
          }
        });
      }
    };

    optDiv.appendChild(btn);
  });

  setTimeout(() => {
    document.activeElement.blur();
  }, 100);
}

  // –ø—Ä–æ –∑–∞–ø–∞—Å: –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –≤ —Ñ–æ–∫—É—Å–µ ‚Äî —É–±–∏—Ä–∞–µ–º
  setTimeout(() => {
    document.activeElement.blur();
  }, 100);
}


   
  function skipWord() {
    terms = terms.filter(t => t !== current);
    updateProgress();
    showWord();
  }

  document.getElementById("repeat").onclick = () => {
    if (current) playAudio(current[0]);
  };
  document.getElementById("skip").onclick = skipWord;
  document.getElementById("restart").onclick = () => {
    terms = [...fullTerms];
    allTerms = [...fullTerms];
    wrongAnswers = [];
    updateProgress();
    document.getElementById("restart").style.display = "none";
    document.getElementById("retryErrors").style.display = "none";
    document.getElementById("repeat").style.display = "inline-block";
    document.getElementById("skip").style.display = "inline-block";
    showWord();
  };
  document.getElementById("retryErrors").onclick = () => {
    terms = [...wrongAnswers];
    allTerms = [...wrongAnswers];
    wrongAnswers = [];
    updateProgress();
    document.getElementById("retryErrors").style.display = "none";
    document.getElementById("restart").style.display = "none";
    document.getElementById("repeat").style.display = "inline-block";
    document.getElementById("skip").style.display = "inline-block";
    showWord();
  };

  document.getElementById("toggleFont").onclick = () => {
    isHandwritten = !isHandwritten;
    document.getElementById("word").classList.toggle("handwritten", isHandwritten);
  };

 Promise.all([
  fetch("terms.json").then(res => res.json()),
  fetch("audio_map.json").then(res => res.json())
]).then(([termsData, audioMapData]) => {
  const filtered = termsData.filter(t => t[2] === level);
  terms = [...filtered];
  allTerms = [...filtered];
  fullTerms = [...filtered];
  audioMap = audioMapData;

  // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º showWord() —Å—Ä–∞–∑—É!
  setTimeout(() => showWord(), 0); // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ —Å–æ–±—ã—Ç–∏–π
});

</script>
</body>
</html>
